<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>部门管理</title>
    <link rel="stylesheet" href="../../css/bootstrap.css"/>
    <link rel="stylesheet" href="../../css/data-base.css"/>

    <script src="../../js/jquery-3.1.1.js"></script>
    <script src="../../js/layer/layer.js"></script>
    <script src="../../js/bootstrap.js"></script>
</head>
<body>
<!-- Modal -->
<div class="fullbox">
    <h1 class="col-sm-12 col-xs-12"><span class="glycolor glyphicon glyphicon-align-left"></span>&nbsp;部门管理</h1>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">部门</h4>
            </div>
            <div class="modal-body">
                <form action="post" id="divForm">
                    <div class="form-group">
                        <lable>部门编号：</lable>
                        <input type="text" id="ID" class="form-control">
                        <p style="font-size: 12px;color: red;margin: 0"></p>
                    </div>
                    <div class="form-group">
                        <lable>部门名称：</lable>
                        <input type="text" id="divisionName" class="form-control">
                    </div>
                    <div class="form-group">
                        <lable>部门Tell：</lable>
                        <div class="input-group">
                            <div class="input-group-addon">@</div>
                            <input class="form-control" id="Email" type="text">
                            <p style="font-size: 12px;color: red;margin: 0"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="submit" id="editSave"  class="btn btn-success">保存变更</button>
            </div>
        </div>
    </div>
</div>
<!--end Modal-->
<!-- Modal -->
<div class="modal fade" id="myAdd" tabindex="-1" role="dialog"
     aria-labelledby="myAddLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myAddLabel">部门</h4>
            </div>
            <div class="modal-body">
                <form action="post">
                    <div class="form-group">
                        <lable>部门编号：</lable>
                        <input type="text" id="addID" class="form-control">

                    </div>
                    <div class="form-group">
                        <lable>部门名称：</lable>
                        <input type="text" id="adddivisionName" class="form-control">
                    </div>
                    <div class="form-group">
                        <lable>部门Tell：</lable>
                        <div class="input-group">
                            <div class="input-group-addon">@</div>
                            <input class="form-control" id="addEmail"  type="text">
                            <p style="font-size: 12px;color: red;margin: 0"></p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" id="saveAdd" class="btn btn-success">保存变更</button>
            </div>
        </div>
    </div>
</div>
<!--end Modal-->
<!-- Modal -->
<div class="modal fade" id="myStaff" tabindex="-1" role="dialog"
     aria-labelledby="staffLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="staffLabel">员工信息</h4>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-bordered">
                    <thead class="data-tabhead">
                    <tr>
                        <td>员工ID</td>
                        <td>姓名</td>
                        <td>性别</td>
                        <td>电话号码</td>
                        <td>Tell</td>
                        <td>激活状态</td>
                    </tr>
                    </thead>
                    <tbody id="myStaffTable">

                    </tbody>
                </table>
                <div class="data-divpage">
                    <span>上一页</span>
                    <a href="javascript:;">1</a>
                    <a href="javascript:;">2</a>
                    <a href="javascript:;">3</a>
                    <a href="javascript:;">4</a>
                    <a href="javascript:;">5</a>
                    ....
                    <a href="javascript:;">9</a>
                    <span>下一页</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<!--end Modal-->
    <!--table-->
    <div class="data-contexte">
        <!--搜索框-->
        <div class="data-secr">
            <form action="post" class="form-inline">
                <div class="form-group">
                    <lable>部门名称：</lable>
                    <input type="text" id="dividionSearchInput" class="form-control">
                </div>
                <span class="data-pointer" id="dividionSearch">
                    <span class="glyphicon glyphicon-search glyphicon data-pointer"></span>
                    搜索
                </span>
            </form>
        </div>
        <!--end搜索框-->
        <div class="table-responsive data-tableRadius">
            <table class="table table-striped table-bordered">
                <thead class="data-tabhead">
                <tr>
                    <td>部门编号</td>
                    <td>部门名称</td>
                    <td>部门Tell</td>
                    <td>编辑</td>
                    <td>查看成员</td>
                    <td>删除</td>
                </tr>
                </thead>
                <tbody id="mytbody">

                </tbody>
            </table>
            <div class="data-divpage">
                <span onclick="pre()">上一页</span>
                <span onclick="next()">下一页</span>
            </div>
        </div>
        <button class="data-edit data-bw"  data-toggle="modal" data-target="#myAdd">新增部门</button>
    </div>
</div>
</body>
<!--<script src="../../layui/layui.js"></script>-->
<script>
//    window.onload=function(){
        //初始化
        var maxPageNum;
        var pageNum = 1;
        var mytbody=$("#mytbody").get(0);
        var innerhtml;
        var searchText=$("#dividionSearchInput").val();
        searchText=searchText.trim();
        var oldSearchText=searchText;
        function loadData(){
            mytbody.innerHTML="";
            $.ajax({
                url: "load_deparment.do", //请求地址
                type: "post",//请求method类型
                data: {myPageNum:pageNum,mydivisionName:searchText},//参数
                dataType: "json",//返回参数的类型
                async: "true",
                cache: "false",
                success: function(data){
                    var innerhtml=mytbody.innerHTML;
                    for(var i= 0; i<data.length; i++){
                        innerhtml+='<tr><td>'+data[i].d_id+
                        '</td><td>'+data[i].d_name+
                        '</td><td>'+data[i].d_tell+
                        '</td><td>'+'<div class="data-edit" data-toggle="modal" onclick="edit(this)" data-target="#myModal">编辑</div>'+
                        '</td><td>'+'<div class="data-SD" data-toggle="modal" data-target="#myStaff" onclick="getStaff(this)">查看成员</div>'+
                        '</td><td>'+'<div class="data-SD data-dele" onclick="del(this)">删除</div>'+
                        '</td></tr>';
                        //更新oldsearchText
                        oldSearchText=searchText
                    }
                    mytbody.innerHTML=innerhtml;
                }
            });
            //获取maxpageNum
            $.ajax({
                url: "getMaxpageNum.do", //请求地址
                type: "post",//请求method类型
                data: {},//参数
                dataType: "json",//返回参数的类型
                async: true,
                cache: false,//bu从缓存中提取
                success: function(data){
                    maxPageNum=Math.ceil(data[0].countnum/10);
                }
            });
        }
        loadData();
        //翻页
        function pre(){
            if(pageNum>1){
                pageNum--;
                loadData();
            }
        }
        function next(){
            if(pageNum<maxPageNum){
                pageNum++;
                loadData();
            }
        }
        //删除
        function del(obj){
            var ID = $(obj).parent().parent().find('td:nth-child(1)').text();
            layer.open({
                title: '警告！'
                , content: '确定删除吗？'
                , btn: ['确定', '取消']
                , yes: function (index, layero){
                    //添加到数据库
                    $.ajax({
                        url: "delete_deparment.do",//请求地址
                        type: "post",//请求method类型
                        data: {myID:ID},//参数
                        dataType: "json",//返回参数的类型
                        async: "true",
                        cache: "true"
                    });
                    loadData();
                    layer.close(index)
                }
            });
        }
        //编辑
        function edit(obj){
            var ID = $(obj).parent().parent().find('td:nth-child(1)').text();
            var divisionName = $(obj).parent().parent().find('td:nth-child(2)').text();
            var tell = $(obj).parent().parent().find('td:nth-child(3)').text();
            $('#ID').val(ID);
            $('#divisionName').val(divisionName);
            $('#Email').val(tell);
            $('tr').attr('active', '0');
            $(obj).parent().parent().attr('active', '1');
        }
        //编辑保存
        $('#editSave').on('click', function () {
            layer.open({
                title: '警告'
                , content: '确定保存变更吗？'
                , btn: ['确定', '取消']
                , offset: '20%'
                , yes: function (index, layero) {
                // editSave();
                    var ID =$('#ID').val();
                    var divisionName = $('#divisionName').val();
                    var tell = $('#Email').val();
//                    alert(tell);
//                    alert(divisionName);
                    //添加到数据库
                    $.ajax({
                        url: "revise_deparment.do",//请求地址
                        type: "post",//请求method类型
                        data: {myID:ID,mydivisionName:divisionName,myTell:tell},//参数
                        dataType: "json",//返回参数的类型
                        async: "true",
                        cache: "true"
                    });
                    loadData();
                    layer.close(index)
                }
            })
        });
        //查看员工
        function getStaff(obj){
            var ID=$(obj).parent().parent().find("td:nth-child(1)").text();
            var staffTable=$("#myStaffTable").get(0);
            var innerhtml="";
            $.ajax({
                url:"getStaff.do",
                type:"post",
                data:{d_id:ID},
                async:"true",
                cache:"false",
                success: function(data){
                    for(var i=0; i<data.length; i++) {
                        innerhtml +="<tr>" +
                            "<td>" + data[i].s_id + "</td>" +
                            "<td>" + data[i].s_name + "</td>" +
                            "<td>" + data[i].s_sex + "</td>" +
                            "<td>" + data[i].s_tel + "</td>" +
                            "<td>" + data[i].s_email + "</td>" +
                            "<td>" + data[i].s_state + "</td>" +
                        "</tr>"
                    }
                    staffTable.innerHTML=innerhtml;
                }
            })
        }
        //新增并保存到数据库
        $('#saveAdd').click(function(){
            layer.open({
                title: '警告'
                , content: '确定保存变更吗？'
                , btn: ['确定', '取消']
                , offset: '20%'
                , yes: function (index, layero) {
                    var divisionName = $('#adddivisionName').val();
                    var tell = $('#addEmail').val();
                    $.ajax({
                        url: "add_deparment.do", //请求地址
                        type: "post",//请求method类型
                        data: {mydivisionName2:divisionName,myTell:tell},//参数
                        dataType: "json",//返回参数的类型
                        async: "true",
                        cache: "true"
                    });
                    loadData();
                    layer.close(index);
                }
            })
        });
        layer.config({
            skin: 'layui-layer-molv'
        });
        //搜索
        $("#dividionSearch").click(function(){
            searchText=$("#dividionSearchInput").val();
            searchText=searchText.trim();
            loadData();
        });
        setInterval(function(){isChange()},500);
        function isChange(){
            searchText=$("#dividionSearchInput").val();
            searchText=searchText.trim();
            if(searchText!=oldSearchText){
                loadData();
            }
        }
        //验证
        $('#Email').blur(function () {
            regname(this, 'email');
        });
        $('#addEmail').blur(function () {
            regname(this, 'email');
        });
        function regname(obj, type) {
            var text;
            var value = $(obj).val();
            if (type == "email") {
                text = "电话格式不正确";
            }
            var a = reg(value, type);
            if (!a) {
                $(obj).next().text(text);
            } else if (a) {
                $(obj).next().text("");
            }
        }
        function reg(a, type){
            var reg;
            if (type == "email"){
                reg = /^[0-9]{1,10}$/;
            }
            return reg.test(a);
        }
//    }
</script>
</html>